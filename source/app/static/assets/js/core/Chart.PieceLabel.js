/**
 * [Chart.PieceLabel.js]{@link https://github.com/emn178/Chart.PieceLabel.js}
 *
 * @version 0.9.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2017
 * @license MIT
 */
!function(){function t(){this.drawDataset=this.drawDataset.bind(this)}"undefined"==typeof Chart?console.warn("Can not find Chart object."):(t.prototype.beforeDatasetsUpdate=function(t){if(this.parseOptions(t)&&"outside"===this.position){var e=1.5*this.fontSize+2;t.chartArea.top+=e,t.chartArea.bottom-=e}},t.prototype.afterDatasetsDraw=function(t){this.parseOptions(t)&&(this.labelBounds=[],t.config.data.datasets.forEach(this.drawDataset))},t.prototype.drawDataset=function(t){for(var e=this.ctx,i=this.chartInstance,o=t._meta[Object.keys(t._meta)[0]],a=0,s=0;s<o.data.length;s++){var r=o.data[s],n=r._view;if(0!==n.circumference||this.showZero){switch(this.render){case"value":var h=t.data[s];this.format&&(h=this.format(h)),h=h.toString();break;case"label":h=i.config.data.labels[s];break;case"image":h=this.images[s]?this.loadImage(this.images[s]):"";break;default:var l=n.circumference/this.options.circumference*100;l=parseFloat(l.toFixed(this.precision)),this.showActualPercentages||100<(a+=l)&&(l-=a-100,l=parseFloat(l.toFixed(this.precision))),h=l+"%"}if("function"==typeof this.render&&("object"==typeof(h=this.render({label:i.config.data.labels[s],value:t.data[s],percentage:l,dataset:t,index:s}))&&(h=this.loadImage(h))),!h)break;if(e.save(),e.beginPath(),e.font=Chart.helpers.fontString(this.fontSize,this.fontStyle,this.fontFamily),"outside"===this.position||"border"===this.position&&"pie"===i.config.type){var f,c=n.outerRadius/2,p=this.fontSize+2,d=n.startAngle+(n.endAngle-n.startAngle)/2;if("border"===this.position?f=(n.outerRadius-c)/2+c:"outside"===this.position&&(f=n.outerRadius-c+c+p),d={x:n.x+Math.cos(d)*f,y:n.y+Math.sin(d)*f},"outside"===this.position){d.x=d.x<n.x?d.x-p:d.x+p;var u=n.outerRadius+p}}else c=n.innerRadius,d=r.tooltipPosition();if("function"==typeof(p=this.fontColor)?p=p({label:i.config.data.labels[s],value:t.data[s],percentage:l,text:h,backgroundColor:t.backgroundColor[s],dataset:t,index:s}):"string"!=typeof p&&(p=p[s]||this.options.defaultFontColor),this.arc)u||(u=(c+n.outerRadius)/2),e.fillStyle=p,e.textBaseline="middle",this.drawArcText(h,u,n,this.overlap);else{c=this.measureText(h),n=d.x-c.width/2,c=d.x+c.width/2;var g=d.y-this.fontSize/2,x=d.y+this.fontSize/2;(this.overlap||("outside"===this.position?this.checkTextBound(n,c,g,x):r.inRange(n,g)&&r.inRange(n,x)&&r.inRange(c,g)&&r.inRange(c,x)))&&this.fillText(h,d,p)}e.restore()}}},t.prototype.parseOptions=function(t){var e=t.options.pieceLabel;return!!e&&(this.chartInstance=t,this.ctx=t.chart.ctx,this.options=t.config.options,this.render=e.render||e.mode,this.position=e.position||"default",this.arc=e.arc,this.format=e.format,this.precision=e.precision||0,this.fontSize=e.fontSize||this.options.defaultFontSize,this.fontColor=e.fontColor||this.options.defaultFontColor,this.fontStyle=e.fontStyle||this.options.defaultFontStyle,this.fontFamily=e.fontFamily||this.options.defaultFontFamily,this.hasTooltip=t.tooltip._active&&t.tooltip._active.length,this.showZero=e.showZero,this.overlap=e.overlap,this.images=e.images||[],this.showActualPercentages=e.showActualPercentages||!1,!0)},t.prototype.checkTextBound=function(t,e,i,o){for(var a=this.labelBounds,s=0;s<a.length;++s){for(var r=a[s],n=[[t,i],[t,o],[e,i],[e,o]],h=0;h<n.length;++h){var l=n[h][0],f=n[h][1];if(l>=r.left&&l<=r.right&&f>=r.top&&f<=r.bottom)return!1}for(n=[[r.left,r.top],[r.left,r.bottom],[r.right,r.top],[r.right,r.bottom]],h=0;h<n.length;++h)if(l=n[h][0],f=n[h][1],l>=t&&l<=e&&f>=i&&f<=o)return!1}return a.push({left:t,right:e,top:i,bottom:o}),!0},t.prototype.measureText=function(t){return"object"==typeof t?{width:t.width,height:t.height}:this.ctx.measureText(t)},t.prototype.fillText=function(t,e,i){var o=this.ctx;"object"==typeof t?o.drawImage(t,e.x-t.width/2,e.y-t.height/2,t.width,t.height):(o.fillStyle=i,o.textBaseline="top",o.textAlign="center",o.fillText(t,e.x,e.y-this.fontSize/2))},t.prototype.loadImage=function(t){var e=new Image;return e.src=t.src,e.width=t.width,e.height=t.height,e},t.prototype.drawArcText=function(t,e,i,o){var a=this.ctx,s=i.x,r=i.y,n=i.startAngle;i=i.endAngle,a.save(),a.translate(s,r),r=i-n;var h=n+=Math.PI/2;if(n+=((i+=Math.PI/2)-((s=this.measureText(t)).width/e+n))/2,o||!(i-n>r))if("string"==typeof t)for(a.rotate(n),o=0;o<t.length;o++)n=t.charAt(o),s=a.measureText(n),a.save(),a.translate(0,-1*e),a.fillText(n,0,0),a.restore(),a.rotate(s.width/e);else a.rotate((h+i)/2),a.translate(0,-1*e),this.fillText(t,{x:0,y:0});a.restore()},Chart.pluginService.register({beforeInit:function(e){e.pieceLabel=new t},beforeDatasetsUpdate:function(t){t.pieceLabel.beforeDatasetsUpdate(t)},afterDatasetsDraw:function(t){t.pieceLabel.afterDatasetsDraw(t)}}))}();